---
title: "Asignación de clima a ciclos de cultivo"
author: Centro Internacional de Agricultura Trópical grupo de Big-Data AEPS <br/>
  Hugo Dorado
date: "April 26, 2018"
output:
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción

La asignación de variables climáticas a ciclos de cosecha utilizando estaciones meteorológicas, se realiza por medio de un proceso que consiste inicialmente en definir la coincidencia entre sitios de cultivo y ubicación de la estaciones, dicha coincidencia se define por medio de diferencias entre altura y proximidad espacial, las cuales se evalúan por medio de restricciones que pueden variar por variable (por ejemplo la distancia aplicada para temperatura puede ser menos rigurosa que la distancia en precipitación). Un paso posterior a evaluar las coincidencias es el de calcular indicadores climáticos por cada una de las variables de interés dentro del ciclo, para lo cual se utilizan promedios, desviaciones estándar, acumulados y frecuencias.


## Preparación previa

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(here)
library(data.table)
library(plyr)
library(Imap)
library(pgirmess)
```

```{r message=FALSE, warning=FALSE}
source(here::here('SCRIPTS','Merge_Stations_Funs.R'))

load(here::here('RESULTS','Catalogs.RData'))
load(here::here('BASIC_FILES','list_Stations_Process.RData'))
load(here::here('BASIC_FILES','list_Station_Unprocess.RData'))
```



## Estaciones útiles de acuerdo a las fechas de los ciclos de siembra

```{r}
# Filter stations per availability

earlist_date_crop_cycle <- min(crop_cycles$Ini_Date)
lastest_data_crop_cycle <- max(crop_cycles$End_Date) 


rule1 <- earlist_date_crop_cycle > Stations_catalog$Max_Date
rule2 <- lastest_data_crop_cycle < Stations_catalog$Min_Date

Stations_target <- Stations_catalog[!(rule1|rule2),]
```

## Ciclos de siembra que pueden ser vinculados a estaciones por sus fechas de siembra 

```{r}
# Filter station per cropping cycles

crop_cycles <- crop_cycles[min(Stations_target$Min_Date) < crop_cycles$Ini_Date,]
```

## Vinculación de ciclos de siembra 

```{r}
# Merge the station and cropping cycles according distances rules that are specified in the function,
# the time period between station - cropping cycles is validated as well, station and crop_cycles which
# don't

merg_Station <- merge_Stations(Stations_target,crop_cycles,crop_cycle_Name= 'FID',
              Dtemp  = 30000, Drain  = 15000,
              Drhum  = 30000, Drads  = 30000,
              DifElv = 150)
```


## Seleccionar estaciones que hayan cumplido con las restricciones definidas por los lotes

```{r}
# Extract the usefullStation list

usefullStation <- merg_Station$usefullStation

# Selecting only fileds which have avaliable stations

crop_cycles <- crop_cycles[crop_cycles$FID %in% usefullStation$ID_crop_cycle,]
```

## Identificar por variable, la estación que mejor represente la información climática.  

```{r}
# Assigning each variable for each station

crop_cycle_vars_station_assignation <- assing_var_station(crop_cycles,usefullStation)

# Assigning daily weather information for each event variable

Final_weather_assign <- weather_assignation(crop_cycle_vars_station_assignation,list_Stations_Process)
```

## Generar indicadores climáticos por cada uno de los ciclos de acuerdo a la asignación.

```{r}
# Generating weather indicators

Final_indicators <- weather_indicators(Final_weather_assign)
```

# Almacenar resultados 

```{r}
# Files to save

save( Final_weather_assign , file=here::here("RESULTS","Final_weather_assign.RData"))

write.csv(Final_indicators,here::here("RESULTS","Final_indicators.csv"),row.names = F)
```

(C\) *2018, Grupo Big Data y  Agricultura Específica por Sitio, Centro Internacional de Agricultura Trópical*
